build_steps:
    - desc: Prepare Environment
      cmd: |
        apt-get update
        apt-get install -y python3 python3-pip
        pip3 install docker-squash

    - desc: Install Docker
      cmd: 'curl -sSL https://get.docker.com/ | sh'

    - desc: Build and push docker images
      cmd: |
        cd  postgres-appliance

        PATRONIVERSION=$(sed -n 's/^ENV PATRONIVERSION=\([1-9][0-9]*\.[1-9][0-9]*\).*$/\1/p' Dockerfile.build)
        IMAGE="registry-write.opensource.zalan.do/acid/spilo-cdp-11:${PATRONIVERSION}-p${CDP_TARGET_BRANCH_COUNTER}"

        ./build.sh --build-arg COMPRESS=true -t "${IMAGE}" .

        docker images

        docker push "${IMAGE}"
